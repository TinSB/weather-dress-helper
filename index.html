<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>26Â°C ç©¿è¡£åŠ©æ‰‹ | æ™ºèƒ½é…è‰²ç‰ˆ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¨</text></svg>">
    
    <!-- å¼•å…¥å¤–éƒ¨åº“ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        amber: { 50: '#fffbeb', 100: '#fef3c7', 200: '#fde68a', 300: '#fcd34d', 400: '#fbbf24', 500: '#f59e0b', 600: '#d97706', 700: '#b45309', 800: '#92400e' }
                    },
                    fontFamily: { mono: ['"JetBrains Mono"', 'monospace'] },
                    animation: {
                        'bounce-in': 'bounceIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        bounceIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #fdfbf7 0%, #fff7ed 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* å¼€å±åŠ¨ç”» */
        #introOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ffffff;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease-out;
        }

        .intro-bg-circle {
            position: absolute;
            width: 20rem;
            height: 20rem;
            background-color: #fef3c7;
            border-radius: 9999px;
            filter: blur(64px);
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; transform: scale(0.95); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        /* å³é”®èœå• */
        #contextMenu {
            position: fixed;
            z-index: 1000;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 6px;
            width: 120px;
            display: none;
            transform-origin: top left;
        }

        .context-item {
            padding: 8px 12px;
            font-size: 13px;
            cursor: pointer;
            color: #4b5563;
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 6px;
            font-weight: 500;
        }

        .context-item:hover {
            background-color: #fffbeb;
            color: #b45309;
        }

        .context-item.delete:hover {
            background-color: #fef2f2;
            color: #ef4444;
        }

        /* ä»ªè¡¨ç›˜æ¸å˜ */
        .meter-gradient {
            background: linear-gradient(90deg, #3b82f6 0%, #22c55e 50%, #ef4444 100%);
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* è¡£ç‰©æŒ‰é’® */
        .clothing-btn {
            transition: all 0.15s ease;
            position: relative;
            overflow: visible;
        }

        .clothing-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .clothing-btn.selected {
            background-color: #fffbeb;
            border-color: #f59e0b;
            color: #92400e;
            box-shadow: 0 0 0 1px #f59e0b inset;
        }

        .layer-tag {
            position: absolute;
            bottom: 2px;
            right: 3px;
            font-size: 9px;
            padding: 1px 4px;
            border-radius: 4px;
            font-weight: 700;
            opacity: 0.85;
        }

        .layer-inner { background-color: #fee2e2; color: #991b1b; }
        .layer-outer { background-color: #e0f2fe; color: #075985; }

        /* è°ƒèŠ‚å™¨æŒ‰é’® */
        .modifier-btn.active {
            background-color: #eff6ff;
            border-color: #3b82f6;
            color: #1d4ed8;
        }

        .modifier-btn[data-effect="warm"].active {
            background-color: #fff7ed;
            border-color: #f59e0b;
            color: #b45309;
        }

        /* é¢œè‰²é€‰æ‹©å™¨ */
        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }

        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.active {
            border-color: #4b5563;
            transform: scale(1.15);
            box-shadow: 0 0 0 2px white inset;
        }

        .color-wheel-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: #f3f4f6;
            transition: background 0.2s;
        }
        .color-wheel-btn:hover { background: #e5e7eb; }

        /* è§†å›¾åˆ‡æ¢ */
        .view-section {
            display: none;
            animation: fadeInView 0.3s ease-out;
        }

        .view-section.active { display: block; }

        @keyframes fadeInView {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .nav-tab {
            padding: 8px 16px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 14px;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-tab.active {
            background-color: #fff;
            color: #d97706;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            z-index: 50;
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .custom-scroll::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 4px; }

        .emoji-option {
            cursor: pointer;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            aspect-ratio: 1;
            transition: all 0.1s;
            border: 2px solid transparent;
        }

        .emoji-option:hover { background-color: #fffbeb; }
        .emoji-option.selected {
            background-color: #fff7ed;
            border-color: #f59e0b;
            color: #92400e;
            box-shadow: 0 0 0 1px #f59e0b inset;
        }

        .az-sidebar {
            position: absolute;
            right: 2px;
            top: 60px;
            bottom: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 1px;
            z-index: 20;
            font-size: 9px;
            color: #9ca3af;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 4px 2px;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.02);
        }

        .az-link {
            cursor: pointer;
            padding: 0 4px;
            font-weight: 600;
            text-align: center;
            transition: transform 0.1s;
        }

        .az-link:hover { color: #d97706; transform: scale(1.4); }

        .pref-option {
            cursor: pointer;
            border: 2px solid #e5e7eb;
            transition: all 0.2s;
        }

        .pref-option:hover { border-color: #fcd34d; }
        .pref-option.active {
            border-color: #f59e0b;
            background-color: #fffbeb;
            color: #92400e;
        }

        .ratio-btn.active {
            background-color: #f59e0b;
            border-color: #f59e0b;
            color: white;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
        }

        input:checked + label {
            background-color: #fff7ed;
            border-color: #f59e0b;
            color: #b45309;
        }
    </style>
</head>
<body class="text-gray-800" onclick="hideContextMenu()">

    <!-- å…¨å±€é”™è¯¯æ˜¾ç¤ºï¼ˆå…œåº•ï¼‰ -->
    <div id="globalError" class="hidden fixed top-0 left-0 w-full bg-red-500 text-white p-2 text-center z-[1000] text-sm font-bold"></div>

    <!-- å³é”®èœå• -->
    <div id="contextMenu" onclick="event.stopPropagation()">
        <div class="context-item" onclick="handleEditCustom(); hideContextMenu();">âœï¸ ç¼–è¾‘</div>
        <div class="context-item delete" onclick="handleDeleteCustom(); hideContextMenu();">ğŸ—‘ï¸ åˆ é™¤</div>
    </div>

    <!-- å¼€å±åŠ¨ç”» -->
    <div id="introOverlay">
        <button onclick="forceCloseIntro()" class="absolute top-6 right-6 text-amber-700 font-semibold text-sm border border-amber-200 px-4 py-2 rounded-full hover:bg-amber-100 transition z-50 cursor-pointer bg-white shadow-sm">è·³è¿‡ ></button>
        <div class="intro-bg-circle"></div>
        <div class="relative z-10 text-center space-y-4 animate-bounce-in">
            <div class="text-6xl mb-2 drop-shadow-sm">ğŸŒ</div>
            <div class="space-y-2">
                <h1 id="introTitle" class="text-3xl md:text-4xl font-extrabold text-gray-800 tracking-tight">å…¨çƒå®šä½ä¸­...</h1>
                <div class="flex items-center justify-center gap-2 text-amber-600 font-medium text-sm">
                    <span id="introSubtitle">æ­£åœ¨è¿æ¥æ°”è±¡å«æ˜Ÿæ•°æ®</span>
                </div>
            </div>
        </div>
        <div class="absolute bottom-10 text-amber-400 text-xs opacity-60">å¦‚é•¿æ—¶é—´æ— å“åº”è¯·ç‚¹å‡»å³ä¸Šè§’è·³è¿‡</div>
    </div>

    <!-- åŸå¸‚æœç´¢æ¨¡æ€æ¡† -->
    <div id="citySearchModal" class="hidden modal-backdrop" onclick="if(event.target === this) toggleCitySearch(false)">
        <div class="bg-white w-full max-w-md h-[70vh] rounded-2xl shadow-2xl overflow-hidden border border-gray-100 flex flex-col relative" onclick="event.stopPropagation()">
            <div class="p-3 border-b border-gray-100 bg-gray-50/80 backdrop-blur-sm flex-shrink-0 z-30">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-gray-800 text-base">é€‰æ‹©åŸå¸‚</h3>
                    <button onclick="toggleCitySearch(false)" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-200 text-gray-500 hover:bg-gray-300">&times;</button>
                </div>
                <div class="relative">
                    <input type="text" id="citySearchInput" placeholder="æœç´¢å…¨çƒåŸå¸‚ (ä¸­/è‹±)..." autocomplete="off"
                           class="w-full pl-9 pr-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-amber-500 focus:ring-2 focus:ring-amber-50 transition-all bg-white text-sm">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">ğŸ”</span>
                    <div id="searchLoading" class="hidden absolute right-3 top-1/2 -translate-y-1/2"><svg class="animate-spin h-4 w-4 text-amber-500" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto custom-scroll relative bg-gray-50" id="cityListContainer">
                <div id="azSidebar" class="az-sidebar"></div>
                <div id="browseView" class="pb-8"></div>
                <div id="searchResultsView" class="hidden p-3"></div>
            </div>
        </div>
    </div>

    <!-- åå¥½è®¾ç½® -->
    <div id="settingsModal" class="hidden modal-backdrop" onclick="if(event.target === this) toggleSettings(false)">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-xl p-5 border border-gray-100 relative" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-800 text-base">âš™ï¸ åå¥½è®¾ç½®</h3>
                <button onclick="toggleSettings(false)" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-500 uppercase">ä½“è´¨æ•æ„Ÿåº¦</label>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="pref-option rounded-lg p-2 text-center border-2 border-gray-100 hover:border-amber-300" data-type="hot" onclick="setPreference('hot')"><div class="text-xl">ğŸ”¥</div><div class="font-bold text-xs">æ€•çƒ­</div><div class="text-[10px] text-gray-400">-2Â°</div></div>
                        <div class="pref-option rounded-lg p-2 text-center border-2 border-gray-100 hover:border-amber-300 active" data-type="normal" onclick="setPreference('normal')"><div class="text-xl">ğŸ˜</div><div class="font-bold text-xs">æ­£å¸¸</div><div class="text-[10px] text-gray-400">26Â°</div></div>
                        <div class="pref-option rounded-lg p-2 text-center border-2 border-gray-100 hover:border-amber-300" data-type="cold" onclick="setPreference('cold')"><div class="text-xl">â„ï¸</div><div class="font-bold text-xs">æ€•å†·</div><div class="text-[10px] text-gray-400">+2Â°</div></div>
                    </div>
                </div>
                <div class="space-y-2 pt-3 border-t border-gray-100">
                    <div class="flex justify-between items-center">
                        <label class="text-xs font-bold text-gray-500 uppercase">åŸºå‡†ä½“æ„Ÿæ¸©åº¦</label>
                        <div class="relative w-20"><input type="number" id="targetTempInput" value="26" class="w-full pl-2 pr-6 py-1.5 border-2 border-gray-200 rounded-md font-bold text-center text-sm focus:border-amber-400 outline-none"><span class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs">Â°C</span></div>
                    </div>
                </div>
                <div class="pt-3 border-t border-gray-100">
                    <button onclick="resetClothingDB()" class="text-xs text-red-400 hover:text-red-600 underline w-full text-center">âš ï¸ æ¢å¤å‡ºå‚è¡£ç‰©åº“</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¡£ç‰©ç¼–è¾‘ -->
    <div id="customModal" class="hidden modal-backdrop" onclick="if(event.target === this) toggleCustomModal(false)">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-xl p-5 border border-gray-100 relative" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-800 text-base" id="modalTitle">ğŸ¨ æ·»åŠ è¡£ç‰©</h3>
                <button onclick="toggleCustomModal(false)" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
            </div>
            <form id="customForm" onsubmit="event.preventDefault(); saveCustomItem();" class="space-y-4">
                <input type="hidden" id="customType" value="tops"><input type="hidden" id="editIndex" value="-1"><input type="hidden" id="selectedEmoji" value="ğŸ‘•">
                <div class="space-y-2">
                    <div><label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">é€‰æ‹©å›¾æ ‡</label><div id="emojiGrid" class="grid grid-cols-6 gap-2 max-h-32 overflow-y-auto custom-scroll p-2 border border-gray-100 rounded-lg bg-gray-50"></div></div>
                    <div><label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">åç§°</label><input type="text" id="customName" class="w-full p-2 border-2 border-gray-200 rounded-lg text-sm focus:border-amber-400 outline-none" required></div>
                </div>
                <div><label class="block text-[10px] font-bold text-gray-500 uppercase mb-1" id="tempInputLabel">å‡æ¸©å€¼ (Â°C)</label><div class="relative"><input type="number" id="customTemp" step="0.1" class="w-full p-2 border-2 border-gray-200 rounded-lg text-sm focus:border-amber-400 outline-none font-bold" required></div></div>
                <div id="layerSelector" class="hidden space-y-1">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">ç©¿æ³•å±‚çº§</label>
                    <div class="grid grid-cols-2 gap-2">
                        <div><input type="radio" name="customLayer" id="layerInner" value="inner" class="hidden"><label for="layerInner" class="block text-center p-2 border border-gray-200 rounded-lg cursor-pointer text-xs hover:bg-red-50 hover:border-red-200">ğŸ©³ å†…æ­å±‚</label></div>
                        <div><input type="radio" name="customLayer" id="layerOuter" value="outer" class="hidden" checked><label for="layerOuter" class="block text-center p-2 border border-gray-200 rounded-lg cursor-pointer text-xs hover:bg-blue-50 hover:border-blue-200">ğŸ‘– å¤–ç©¿å±‚</label></div>
                    </div>
                    <button type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-2.5 rounded-xl shadow-sm text-sm">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <main class="container mx-auto max-w-6xl px-4 py-4 md:py-6 space-y-4 relative">
        
        <!-- Header & Tab Switcher -->
        <header class="flex flex-col md:flex-row justify-between items-end md:items-center gap-3 border-b border-amber-100 pb-3">
            <div class="w-full md:w-auto space-y-0.5">
                <div class="flex items-center gap-2 flex-wrap">
                    <div id="greetingDate" class="text-[10px] font-bold text-amber-600 uppercase tracking-widest bg-amber-50 px-2 py-0.5 rounded">--</div>
                    <button onclick="toggleCitySearch(true)" id="locationBadge" class="hidden group text-[10px] bg-white text-gray-600 px-2 py-0.5 rounded-full border border-gray-200 hover:border-amber-400 flex items-center gap-1 cursor-pointer"><span>ğŸ“</span> <span id="locationName" class="font-bold">...</span></button>
                    <button onclick="toggleSettings(true)" class="text-[10px] bg-white text-gray-500 px-2 py-0.5 rounded-full border border-gray-200 hover:border-gray-400 flex items-center gap-1 cursor-pointer ml-1"><span>âš™ï¸</span> <span id="prefBadge">æ­£å¸¸</span></button>
                </div>
                <div class="flex items-baseline gap-3">
                    <h1 id="greetingTitle" class="text-2xl md:text-3xl font-extrabold text-gray-900 tracking-tight">ä½ å¥½</h1>
                    <div class="text-xl font-mono font-bold text-gray-400" id="digitalClock">00:00</div>
                </div>
            </div>
            
            <!-- é¡µé¢åˆ‡æ¢ Tab -->
            <div class="flex bg-gray-100 p-1 rounded-full">
                <div onclick="switchTab('calc')" id="tabCalc" class="nav-tab active">ğŸŒ¡ï¸ æ¸©åº¦è®¡ç®—</div>
                <div onclick="switchTab('color')" id="tabColor" class="nav-tab">ğŸ¨ ç©¿æ­è°ƒè‰²</div>
            </div>

            <div class="flex items-center gap-3">
                <div class="text-xs text-gray-500 bg-gray-50 px-3 py-1 rounded-lg border border-gray-100">
                     ç›®æ ‡: <span id="targetDisplay" class="font-bold text-amber-600">26Â°</span>
                </div>
                <div class="bg-white p-0.5 rounded-lg border border-amber-200 shadow-sm flex items-center">
                    <button id="btnCelsius" class="px-3 py-1 rounded-md font-bold text-xs transition-all bg-amber-500 text-white">Â°C</button>
                    <button id="btnFahrenheit" class="px-3 py-1 rounded-md font-bold text-xs transition-all text-amber-800">Â°F</button>
                </div>
            </div>
        </header>

        <!-- VIEW 1: Calculator -->
        <div id="viewCalc" class="view-section active">
            <section class="grid grid-cols-1 lg:grid-cols-12 gap-4 lg:gap-6">
                <!-- Left Column -->
                <div class="lg:col-span-5 space-y-4 flex flex-col">
                    <!-- Weather -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-amber-500"></div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-gray-500 uppercase">å®æ—¶ç¯å¢ƒ</label>
                            <div class="flex gap-2">
                                <button onclick="toggleCitySearch(true)" class="text-[10px] text-amber-600 bg-amber-50 px-2 py-0.5 rounded hover:bg-amber-100">ğŸ” æ¢åŸå¸‚</button>
                                <button id="locateBtn" class="text-[10px] text-gray-400 hover:text-gray-600">ğŸ”„ åˆ·æ–°</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between mb-3">
                            <div class="relative group w-1/3">
                                <input type="number" id="ambientTemp" placeholder=" " step="0.1" class="w-full pl-0 pr-1 py-0 border-none text-4xl font-extrabold text-gray-800 bg-transparent p-0 m-0 focus:outline-none">
                                <span class="text-sm text-gray-400 font-bold unit-label">Â°C</span>
                            </div>
                            <div id="liveWeatherData" class="hidden grid grid-cols-2 gap-x-3 gap-y-1 text-[10px] text-gray-500 bg-gray-50 p-2 rounded-lg border border-gray-100 w-2/3">
                                <span class="flex items-center gap-1">â˜ï¸ <span id="liveCondition" class="font-semibold text-gray-700 truncate">--</span></span>
                                <span class="flex items-center gap-1">ğŸ’§ <b id="liveHumidity" class="text-gray-700">--</b>%</span>
                                <span class="flex items-center gap-1">ğŸƒ <b id="liveWind" class="text-gray-700">--</b>m/s</span>
                                <span class="flex items-center gap-1">ğŸ‘ï¸ <b id="liveApparent" class="text-gray-700">--</b><span class="unit-label">Â°</span></span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <button id="modWind" class="modifier-btn flex items-center justify-between px-3 py-2 rounded-lg border border-gray-200 text-xs font-medium text-gray-600 hover:bg-gray-50 transition-all" data-val="-3"><span>ğŸƒ é£å¤§</span> <span class="mod-val text-[10px] bg-blue-100 text-blue-700 px-1 rounded font-bold">-3Â°</span></button>
                            <button id="modHumid" class="modifier-btn flex items-center justify-between px-3 py-2 rounded-lg border border-gray-200 text-xs font-medium text-gray-600 hover:bg-gray-50 transition-all" data-val="-2"><span>ğŸ’§ é˜´å†·</span> <span class="mod-val text-[10px] bg-blue-100 text-blue-700 px-1 rounded font-bold">-2Â°</span></button>
                            <button id="modSun" class="modifier-btn flex items-center justify-between px-3 py-2 rounded-lg border border-gray-200 text-xs font-medium text-gray-600 hover:bg-gray-50 transition-all" data-val="2"><span>â˜€ï¸ æ™´æœ—</span> <span class="mod-val text-[10px] bg-orange-100 text-orange-700 px-1 rounded font-bold">+2Â°</span></button>
                            <button id="modActive" class="modifier-btn flex items-center justify-between px-3 py-2 rounded-lg border border-gray-200 text-xs font-medium text-gray-600 hover:bg-gray-50 transition-all" data-val="3"><span>ğŸƒ è¿åŠ¨</span> <span class="mod-val text-[10px] bg-orange-100 text-orange-700 px-1 rounded font-bold">+3Â°</span></button>
                        </div>
                        <div class="flex justify-between items-center pt-2 border-t border-gray-50 text-[10px] text-gray-400">
                            <span>å®é™…è®¡ç®—åŸºå‡†:</span><span id="realFeelDisplay" class="font-bold text-gray-600 text-xs">--</span>
                        </div>
                    </div>

                    <!-- Dashboard -->
                    <div class="bg-gray-900 rounded-xl shadow-lg p-4 text-white relative overflow-hidden flex-shrink-0">
                        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-amber-500 opacity-10 rounded-full blur-xl"></div>
                        <div class="grid grid-cols-2 gap-4 relative z-10 mb-3">
                            <div class="space-y-0.5">
                                <div class="text-gray-400 text-[10px] uppercase tracking-wider font-semibold">ä»éœ€è¡¥å……</div>
                                <div class="text-3xl font-bold text-amber-400 leading-none"><span id="neededTemp">--</span><span class="text-sm ml-1 unit-label">Â°C</span></div>
                            </div>
                            <div class="space-y-0.5 text-right">
                                <div class="text-gray-400 text-[10px] uppercase tracking-wider font-semibold">å·²é€‰è¡£ç‰©</div>
                                <div class="text-3xl font-bold text-blue-300 leading-none"><span id="currentTemp">0</span><span class="text-sm ml-1 unit-label">Â°C</span></div>
                            </div>
                        </div>
                        <div class="space-y-1 relative z-10">
                            <div class="h-2 bg-gray-700 rounded-full overflow-hidden relative">
                                <div class="meter-gradient"></div>
                                <div id="meterMarker" class="absolute top-0 w-1 h-full bg-white shadow-[0_0_4px_rgba(255,255,255,1)] transition-all duration-500 ease-out" style="left: 50%; transform: translateX(-50%);"></div>
                            </div>
                            <div id="feelingText" class="text-center font-bold text-sm min-h-[1.25rem]"></div>
                        </div>
                    </div>
                    <button id="resetButton" class="w-full py-2 px-4 bg-white border border-gray-200 hover:bg-gray-50 text-gray-600 font-semibold text-xs rounded-lg transition-all shadow-sm flex items-center justify-center gap-2"><span>â†º</span> é‡ç½®æ‰€æœ‰</button>
                </div>

                <!-- Right Column -->
                <div class="lg:col-span-7 space-y-4">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wide">ä¸Šè£… (Tops) <span class="text-[9px] font-normal normal-case ml-1 text-gray-300">å³é”®ç¼–è¾‘</span></h3>
                            <button onclick="toggleCustomModal(true, 'tops')" class="text-[10px] text-amber-600 bg-amber-50 border border-amber-200 px-2 py-0.5 rounded hover:bg-amber-100 transition-colors font-bold">+ è‡ªå®šä¹‰</button>
                        </div>
                        <div id="topsContainer" class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-2 max-h-[280px] overflow-y-auto custom-scroll p-1"></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wide">ä¸‹è£… (Bottoms)</h3>
                            <div class="flex items-center gap-3">
                                <div class="text-[9px] text-gray-400 flex gap-2"><span class="flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-red-200"></span>å†…æ­</span><span class="flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-blue-200"></span>å¤–ç©¿</span></div>
                                <button onclick="toggleCustomModal(true, 'bottoms')" class="text-[10px] text-amber-600 bg-amber-50 border border-amber-200 px-2 py-0.5 rounded hover:bg-amber-100 transition-colors font-bold">+ è‡ªå®šä¹‰</button>
                            </div>
                        </div>
                        <div id="bottomsContainer" class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-2 max-h-[200px] overflow-y-auto custom-scroll p-1"></div>
                    </div>
                </div>
            </section>
        </div>

        <!-- VIEW 2: Color -->
        <div id="viewColor" class="view-section hidden">
            <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 md:p-8 min-h-[500px] flex flex-col md:flex-row gap-8">
                
                <!-- Left: Controls -->
                <div class="flex-1 space-y-5">
                    <!-- é£æ ¼é€‰æ‹©ä¸ç”Ÿæˆ -->
                    <div class="space-y-3 bg-gray-50 p-3 rounded-xl border border-gray-100">
                         <div class="flex justify-between items-center">
                            <h3 class="font-bold text-gray-800 text-sm">âš¡ æ™ºèƒ½ç©¿æ­ç”Ÿæˆ</h3>
                         </div>
                         <div class="flex gap-2">
                            <select id="styleSelector" class="flex-1 text-xs border border-gray-200 rounded-lg px-2 py-2 outline-none focus:border-amber-400 bg-white">
                                <option value="random">ğŸ² éšæœºå…¨é£æ ¼ (Random)</option>
                            </select>
                            <button onclick="generateOutfit()" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-sm transition-all flex-shrink-0">
                                ç”Ÿæˆ
                            </button>
                         </div>
                         
                        <!-- AI Analysis -->
                        <div class="p-3 bg-white rounded-lg border border-amber-100 shadow-sm">
                            <p id="colorAdvice" class="text-xs text-gray-600 leading-relaxed">é€‰æ‹©é£æ ¼å¹¶ç‚¹å‡»ç”Ÿæˆ...</p>
                        </div>
                    </div>

                    <!-- èº«å½¢æ¯”ä¾‹æ§åˆ¶ -->
                    <div class="flex items-center justify-between gap-2 border-b border-gray-100 pb-3">
                        <h4 class="text-xs font-bold text-gray-500 uppercase">ç©¿æ­æ¯”ä¾‹ (Ratio)</h4>
                        <div class="flex gap-1">
                             <button onclick="setProportion('5/5')" id="ratio55" class="ratio-btn active text-[10px] px-3 py-1 rounded border border-gray-200 bg-white hover:bg-gray-50 font-mono transition-all">5:5 ä¼‘é—²</button>
                             <button onclick="setProportion('3/7')" id="ratio37" class="ratio-btn text-[10px] px-3 py-1 rounded border border-gray-200 bg-white hover:bg-gray-50 font-mono transition-all">3:7 æ˜¾é«˜</button>
                        </div>
                    </div>

                    <!-- Top Color & Type -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-end">
                            <div class="flex items-center gap-2">
                                <h4 class="text-xs font-bold text-gray-500 uppercase">ä¸Šè£…</h4>
                                <select id="topTypeSel" onchange="setClothingType('top', this.value)" class="text-[10px] border-none bg-transparent font-bold text-gray-800 focus:outline-none cursor-pointer">
                                    <option value="tshirt">Tæ¤</option>
                                    <option value="shirt">è¡¬è¡«</option>
                                    <option value="hoodie">å«è¡£</option>
                                    <option value="sweater">æ¯›è¡£</option>
                                </select>
                            </div>
                            <span id="colorNameTop" class="text-[10px] font-mono text-gray-400">#e5e7eb</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="grid grid-cols-8 gap-2 flex-1" id="topPalette"></div>
                            <div class="relative color-wheel-btn flex-shrink-0" title="è‡ªå®šä¹‰é¢œè‰²">
                                <span class="text-lg">ğŸŒˆ</span>
                                <input type="color" id="customTopColor" class="absolute inset-0 opacity-0 cursor-pointer" oninput="updateCustomColor('top', this.value)">
                            </div>
                        </div>
                    </div>

                    <!-- Outer Color & Type -->
                    <div class="space-y-2">
                         <div class="flex justify-between items-end">
                             <div class="flex items-center gap-2">
                                <h4 class="text-xs font-bold text-gray-500 uppercase">å¤–å¥—</h4>
                                <select id="outerTypeSel" onchange="setClothingType('outer', this.value)" class="text-[10px] border-none bg-transparent font-bold text-gray-800 focus:outline-none cursor-pointer">
                                    <option value="coat">å¤§è¡£</option>
                                    <option value="jacket">å¤¹å…‹</option>
                                    <option value="blazer">è¥¿è£…</option>
                                    <option value="puffer">ç¾½ç»’æœ</option>
                                </select>
                            </div>
                            <span id="colorNameOuter" class="text-[10px] font-mono text-gray-400">#9ca3af</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="grid grid-cols-8 gap-2 flex-1" id="outerPalette"></div>
                            <div class="relative color-wheel-btn flex-shrink-0" title="è‡ªå®šä¹‰é¢œè‰²">
                                <span class="text-lg">ğŸŒˆ</span>
                                <input type="color" id="customOuterColor" class="absolute inset-0 opacity-0 cursor-pointer" oninput="updateCustomColor('outer', this.value)">
                            </div>
                        </div>
                    </div>

                    <!-- Bottom Color & Type -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-end">
                            <div class="flex items-center gap-2">
                                <h4 class="text-xs font-bold text-gray-500 uppercase">ä¸‹è£…</h4>
                                <select id="bottomTypeSel" onchange="setClothingType('bottom', this.value)" class="text-[10px] border-none bg-transparent font-bold text-gray-800 focus:outline-none cursor-pointer">
                                    <option value="pants">é•¿è£¤</option>
                                    <option value="shorts">çŸ­è£¤</option>
                                    <option value="skirt">åŠèº«è£™</option>
                                </select>
                            </div>
                            <span id="colorNameBottom" class="text-[10px] font-mono text-gray-400">#374151</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="grid grid-cols-8 gap-2 flex-1" id="bottomPalette"></div>
                            <div class="relative color-wheel-btn flex-shrink-0" title="è‡ªå®šä¹‰é¢œè‰²">
                                <span class="text-lg">ğŸŒˆ</span>
                                <input type="color" id="customBottomColor" class="absolute inset-0 opacity-0 cursor-pointer" oninput="updateCustomColor('bottom', this.value)">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Preview -->
                <div class="w-full md:w-1/3 flex flex-col items-center justify-center bg-gray-50 rounded-2xl border border-gray-100 p-6 relative overflow-hidden">
                    <!-- Pattern Definitions -->
                    <svg width="0" height="0" class="absolute">
                        <defs>
                           <filter id="fabric-shadow" x="-20%" y="-20%" width="140%" height="140%">
                                <feDropShadow dx="2" dy="4" stdDeviation="3" flood-opacity="0.15"/>
                           </filter>
                        </defs>
                    </svg>

                    <div class="relative w-64 h-[400px] flex flex-col items-center justify-start pt-8 transition-all duration-500" id="previewContainer">
                        <!-- Top Layer -->
                        <svg id="svgTop" class="absolute top-0 w-64 h-64 z-10 transition-all duration-500 drop-shadow-sm" viewBox="0 0 1024 1024" style="filter: url(#fabric-shadow)">
                            <path id="pathTop" d="" fill="#e5e7eb" stroke="none"/>
                            <path id="detailTop" d="" fill="none" stroke="rgba(0,0,0,0.1)" stroke-width="4"/>
                        </svg>

                        <!-- Bottom Layer -->
                        <svg id="svgBottom" class="absolute top-0 w-64 h-[400px] z-0 transition-all duration-500 drop-shadow-sm" viewBox="0 0 1024 1200" style="filter: url(#fabric-shadow)">
                            <path id="pathBottom" d="" fill="#374151" stroke="none"/>
                            <path id="detailBottom" d="" fill="none" stroke="rgba(0,0,0,0.1)" stroke-width="4"/>
                        </svg>

                        <!-- Outer Layer -->
                        <svg id="svgOuter" class="absolute top-[-10px] w-72 h-80 z-20 transition-all duration-500 drop-shadow-md pointer-events-none" viewBox="0 0 1024 1024" style="filter: url(#fabric-shadow)">
                             <path id="pathOuter" d="" fill="#9ca3af" stroke="none"/>
                             <path id="detailOuter" d="" fill="none" stroke="rgba(0,0,0,0.1)" stroke-width="4"/>
                        </svg>
                    </div>
                    <div class="absolute bottom-4 text-center">
                        <span class="text-[10px] font-bold text-gray-300 uppercase tracking-wider">Live Preview HD</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- å†…ç½®è„šæœ¬ (æ•´åˆäº† config.js å’Œ app.js) -->
    <script>
        // 1. å…¨å±€é”™è¯¯æ•æ‰
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            const errBox = document.getElementById('globalError');
            if(errBox) {
                errBox.textContent = `é”™è¯¯: ${msg} (Line: ${lineNo})`;
                errBox.classList.remove('hidden');
            }
            forceCloseIntro(); // å‡ºé”™æ—¶å¼ºåˆ¶å…³é—­é®ç½©
            return false;
        };

        // 2. æ•°æ®å®šä¹‰ (åŸ config.js)
        const DEFAULT_CLOTHING = {
            tops: [
              { name: 'èƒŒå¿ƒ', temp: 1, icon: 'ğŸ½' },
              { name: 'çŸ­è¢–T', temp: 1, icon: 'ğŸ‘•' },
              { name: 'POLOè¡«', temp: 1.5, icon: 'ğŸ‘•' },
              { name: 'è¡¬è¡«', temp: 2, icon: 'ğŸ‘”' },
              { name: 'é•¿è¢–T', temp: 2, icon: 'ğŸ‘•' },
              { name: 'é©¬ç”²', temp: 2, icon: 'ğŸ§¶' },
              { name: 'å«è¡£', temp: 3, icon: 'ğŸ§¥' },
              { name: 'è–„æ¯›è¡£', temp: 3, icon: 'ğŸ§¶' },
              { name: 'ä¿æš–è¡£', temp: 3, icon: 'ğŸ”¥' },
              { name: 'åšæ¯›è¡£', temp: 4, icon: 'ğŸ§¶' },
              { name: 'è¥¿è£…', temp: 4, icon: 'ğŸ’¼' },
              { name: 'æ£’çƒæœ', temp: 4.5, icon: 'âš¾' },
              { name: 'é£è¡£', temp: 5, icon: 'ğŸ§¥' },
              { name: 'å†²é”‹è¡£', temp: 5.5, icon: 'ğŸ”ï¸' },
              { name: 'è–„ç¾½ç»’', temp: 6, icon: 'ğŸŒ¬ï¸' },
              { name: 'å¤§è¡£', temp: 7, icon: 'ğŸ§¥' },
              { name: 'æ£‰æœ', temp: 8, icon: 'ğŸ”ï¸' },
              { name: 'ç¾½ç»’æœ', temp: 9, icon: 'â›„' }
            ],
            bottoms: [
              { name: 'çŸ­è£¤', temp: 1, icon: 'ğŸ©³', layer: 'outer' },
              { name: 'çŸ­è£™', temp: 1, icon: 'ğŸ‘—', layer: 'outer' },
              { name: 'è–„é•¿è£¤', temp: 2, icon: 'ğŸ‘–', layer: 'outer' },
              { name: 'ç‰›ä»”è£¤', temp: 3, icon: 'ğŸ‘–', layer: 'outer' },
              { name: 'å·¥è£…è£¤', temp: 3, icon: 'ğŸ‘–', layer: 'outer' },
              { name: 'ä¼‘é—²è£¤', temp: 3, icon: 'ğŸ‘–', layer: 'outer' },
              { name: 'ç™¾è¤¶è£™', temp: 2.5, icon: 'ğŸ‘—', layer: 'outer' },
              { name: 'ç§‹è£¤', temp: 3, icon: 'ğŸ”¥', layer: 'inner' },
              { name: 'åŠ ç»’è£¤', temp: 4, icon: 'ğŸ‘–', layer: 'outer' },
              { name: 'æ£‰è£¤', temp: 5, icon: 'â„ï¸', layer: 'outer' },
              { name: 'ç¾½ç»’è£¤', temp: 7, icon: 'â›„', layer: 'outer' }
            ]
        };

        const PALETTE = [
            { c: '#000000', n: 'é»‘' }, { c: '#ffffff', n: 'ç™½' }, { c: '#9ca3af', n: 'ä¸­ç°' }, { c: '#4b5563', n: 'æ·±ç°' },
            { c: '#f5f5dc', n: 'ç±³è‰²' }, { c: '#d4c4b7', n: 'ç‡•éº¦' }, { c: '#a8a29e', n: 'æš–ç°' }, { c: '#78350f', n: 'æ·±æ£•' }, { c: '#9a3412', n: 'ç„¦ç³–' }, { c: '#92400e', n: 'ç¥ç€' },
            { c: '#94a3b8', n: 'é›¾éœ¾è“' }, { c: '#cbd5e1', n: 'äº‘æ°´è“' }, { c: '#d1fae5', n: 'è±†è”»ç»¿' }, { c: '#e0e7ff', n: 'æ·¡ç´«' }, { c: '#fae8ff', n: 'ç²‰é»›' },
            { c: '#1e3a8a', n: 'è—é’' }, { c: '#1d4ed8', n: 'å…‹è±å› è“' }, { c: '#60a5fa', n: 'å¤©è“' },
            { c: '#15803d', n: 'å†›ç»¿' }, { c: '#0f766e', n: 'å¢¨ç»¿' }, { c: '#b91c1c', n: 'é…’çº¢' },
            { c: '#fcd34d', n: 'å§œé»„' }, { c: '#f472b6', n: 'ç²‰è‰²' }, { c: '#a78bfa', n: 'é¦™èŠ‹ç´«' }, { c: '#14b8a6', n: 'è–„è·ç»¿' },
            { c: '#ef4444', n: 'äº®çº¢' }, { c: '#f97316', n: 'æ´»åŠ›æ©™' }, { c: '#84cc16', n: 'é…¸æ©™ç»¿' }, { c: '#d946ef', n: 'ç«çº¢' }
        ];

        const CLOTHING_ASSETS = {
            top: {
                tshirt: {
                    path: "M256,120 C256,120 340,-20 512,-20 C684,-20 768,120 768,120 L920,300 L780,360 L780,900 L244,900 L244,360 L104,300 Z",
                    detail: "M340,-20 Q512,150 684,-20 M244,360 L300,280 M780,360 L724,280 M768,120 L730,160 M256,120 L294,160 M104,300 Q174,330 244,360 M920,300 Q850,330 780,360"
                },
                shirt: {
                    path: "M256,100 L340,20 L512,80 L684,20 L768,100 L900,300 L780,360 L780,950 L244,950 L244,360 L124,300 Z",
                    detail: "M340,20 L512,180 L684,20 L512,80 Z M512,180 L512,950 M460,300 L512,300 M460,500 L512,500 M460,700 L512,700 M780,800 L850,320 M244,800 L174,320"
                },
                hoodie: {
                    path: "M280,150 C280,150 340,-50 512,-50 C684,-50 744,150 744,150 L920,300 L800,380 L820,920 L204,920 L224,380 L104,300 Z",
                    detail: "M340,50 Q512,200 684,50 M224,380 L280,300 M800,380 L744,300 M350,500 L674,500 L674,700 L350,700 Z M204,850 L820,850"
                },
                sweater: {
                     path: "M260,100 C260,100 350,0 512,0 C674,0 764,100 764,100 L900,280 L780,360 L780,900 L244,900 L244,360 L124,280 Z",
                     detail: "M350,0 Q512,100 674,0 M244,900 L244,830 L780,830 L780,900 M244,360 L260,340 M780,360 L764,340 M124,280 L150,300 M900,280 L874,300"
                }
            },
            outer: {
                coat: {
                     path: "M280,200 L340,20 L684,20 L744,200 L950,150 L980,400 L840,460 L840,1050 L600,1050 L600,350 L424,350 L424,1050 L184,1050 L184,460 L44,400 L74,150 Z",
                     detail: "M340,20 L424,350 L424,900 M684,20 L600,350 L600,900 M424,350 L512,500 L600,350 M250,600 L350,600 M674,600 L774,600 M184,460 L280,200 M840,460 L744,200"
                },
                jacket: {
                     path: "M280,150 L340,20 L684,20 L744,150 L920,120 L940,350 L820,400 L820,850 L204,850 L204,400 L84,350 L104,120 Z",
                     detail: "M512,20 L512,850 M340,20 L424,150 M684,20 L600,150 M220,600 L300,600 M724,600 L804,600 M204,800 L820,800 M84,350 L120,400 M940,350 L904,400"
                },
                blazer: {
                     path: "M260,120 L340,10 L684,10 L764,120 L920,100 L940,320 L820,360 L820,900 L600,900 L600,450 L424,450 L424,900 L204,900 L204,360 L84,320 L104,100 Z",
                     detail: "M340,10 L424,450 M684,10 L600,450 M424,450 L600,450 M424,450 L204,900 M600,450 L820,900 M240,650 L320,650 M704,650 L784,650 M104,100 L120,120"
                },
                puffer: {
                     path: "M240,100 C240,100 340,-20 512,-20 C684,-20 784,100 784,100 L940,250 L820,350 L840,950 L184,950 L204,350 L84,250 Z",
                     detail: "M204,200 L820,200 M190,400 L834,400 M184,600 L840,600 M184,800 L840,800 M512,-20 L512,950 M204,350 L240,100 M820,350 L784,100"
                }
            },
            bottom: {
                pants: {
                     path: "M150,50 L874,50 L910,950 L600,950 L580,350 L560,950 L114,950 Z",
                     detail: "M150,50 L874,50 L860,130 L164,130 Z M512,130 L512,350 M340,350 L340,900 M684,350 L684,900 M160,150 L240,250 M864,150 L784,250"
                },
                shorts: {
                     path: "M160,50 L864,50 L890,550 L560,550 L512,350 L464,550 L134,550 Z",
                     detail: "M160,50 L864,50 L850,130 L174,130 Z M512,130 L512,350 M134,500 L890,500 M174,150 L220,250 L850,150 L804,250"
                },
                skirt: {
                     path: "M200,50 L824,50 L920,750 L104,750 Z",
                     detail: "M200,50 L824,50 L810,130 L214,130 Z M300,130 L250,750 M400,130 L380,750 M512,130 L512,750 M624,130 L644,750 M724,130 L774,750"
                }
            }
        };

        const TYPE_LABELS = {
            top: { tshirt: 'Tæ¤', shirt: 'è¡¬è¡«', hoodie: 'å«è¡£', sweater: 'æ¯›è¡£' },
            bottom: { pants: 'é•¿è£¤', shorts: 'çŸ­è£¤', skirt: 'åŠèº«è£™' },
            outer: { coat: 'å¤§è¡£', jacket: 'å¤¹å…‹', blazer: 'è¥¿è£…', puffer: 'ç¾½ç»’æœ' }
        };

        const STYLES = {
            "old_money": {
                name: "è€é’±é£ (Old Money)",
                desc: "ä½è°ƒå¥¢åï¼Œé¢æ–™è€ƒç©¶ï¼Œå»LogoåŒ–ã€‚",
                items: "è—é’è¥¿è£… + ç™½è‰²è¡¬è¡« + ç±³è‰²ä¼‘é—²è£¤",
                types: { top: 'shirt', outer: 'blazer', bottom: 'pants' },
                colors: { top: ['#ffffff', '#f5f5dc'], bottom: ['#f5f5dc', '#d4c4b7'], outer: ['#1e3a8a', '#78350f'] }
            },
            "clean_fit": {
                name: "Clean Fit",
                desc: "å¹²å‡€åˆ©è½ï¼Œç‰ˆå‹èˆ’é€‚ï¼Œé€‚åº¦å®½æ¾ã€‚",
                items: "ç™½Tæ¤ + æ·±ç°è¥¿è£¤ + æµ…è“è¡¬è¡«(å¤–ç©¿)",
                types: { top: 'tshirt', outer: 'shirt', bottom: 'pants' },
                colors: { top: ['#ffffff', '#9ca3af'], bottom: ['#4b5563', '#374151'], outer: ['#60a5fa', '#9ca3af', '#ffffff'] }
            },
            "intellectual": {
                name: "é«˜æ™ºæ„Ÿ (Intellectual)",
                desc: "æç®€å†·æ·¡ï¼Œç†æ€§å…‹åˆ¶ï¼Œé»‘ç°ä¸ºä¸»ã€‚",
                items: "é»‘è‰²é«˜é¢†è¡« + æ·±ç°æ¯›å‘¢è£¤ + ç°è‰²å¤§è¡£",
                types: { top: 'sweater', outer: 'coat', bottom: 'pants' },
                colors: { top: ['#000000', '#4b5563'], bottom: ['#4b5563', '#000000'], outer: ['#9ca3af', '#4b5563'] }
            },
            "maillard": {
                name: "ç¾æ‹‰å¾· (Maillard)",
                desc: "ç§‹å†¬æ¸©æš–å¤å¤è‰²è°ƒï¼Œæ·±æµ…æ£•è‰²äº¤ç»‡ã€‚",
                items: "ç„¦ç³–è‰²æ¯›è¡£ + æ·±æ£•ç¯èŠ¯ç»’è£¤ + ç‡•éº¦è‰²å¤§è¡£",
                types: { top: 'sweater', outer: 'coat', bottom: 'pants' },
                colors: { top: ['#9a3412', '#78350f'], bottom: ['#78350f', '#9a3412'], outer: ['#d4c4b7', '#a8a29e'] }
            },
            "high_street": {
                name: "é«˜è¡—é£ (High Street)",
                desc: "å»“å½¢å‰ªè£ï¼Œè¡—å¤´æ½®æµï¼Œé…·å¸…æ„Ÿã€‚",
                items: "é»‘è‰²å«è¡£ + å·¥è£…è£¤ + é£è¡Œå‘˜å¤¹å…‹",
                types: { top: 'hoodie', outer: 'jacket', bottom: 'pants' },
                colors: { top: ['#000000', '#4b5563'], bottom: ['#000000', '#374151'], outer: ['#15803d', '#000000'] }
            },
            "ivy": {
                name: "å¸¸é’è—¤ (Ivy League)",
                desc: "å­¦é™¢æ´¾å¤å¤ï¼Œå„’é›…ä¹¦å·æ°”ã€‚",
                items: "ç‰›æ´¥è¡¬è¡« + å¡å…¶è£¤ + é’ˆç»‡é©¬ç”²/è¥¿è£…",
                types: { top: 'shirt', outer: 'sweater', bottom: 'pants' },
                colors: { top: ['#ffffff', '#cbd5e1'], bottom: ['#f5f5dc', '#92400e'], outer: ['#1e3a8a', '#0f766e'] }
            },
            "urbancore": {
                name: "Urbancore (åŸå¸‚æˆ·å¤–)",
                desc: "å…¼é¡¾åŸå¸‚é€šå‹¤ä¸æˆ·å¤–æœºèƒ½ã€‚",
                items: "å†²é”‹è¡£ + æŸè„šè£¤ + æ‘‡ç²’ç»’",
                types: { top: 'hoodie', outer: 'jacket', bottom: 'pants' },
                colors: { top: ['#9ca3af', '#000000'], bottom: ['#000000', '#4b5563'], outer: ['#15803d', '#000000', '#9ca3af'] }
            },
            "vintage": {
                name: "Vintage (å¤ç€å¤å¤)",
                desc: "å¹´ä»£æ„Ÿï¼Œåšæ—§è‰²è°ƒï¼Œç»å…¸è€çœ‹ã€‚",
                items: "åšæ—§çš®è¡£ + ç‰›ä»”è£¤ + èŠ±è¡¬è¡«",
                types: { top: 'shirt', outer: 'jacket', bottom: 'pants' },
                colors: { top: ['#9a3412', '#fcd34d'], bottom: ['#1e3a8a', '#374151'], outer: ['#78350f', '#000000'] }
            },
            "athflow": {
                name: "Athflow (è¿åŠ¨ä¼‘é—²)",
                desc: "ä¼˜é›…ä¸èˆ’é€‚çš„å¹³è¡¡ï¼Œå±…å®¶å¤–å‡ºçš†å®œã€‚",
                items: "å«è¡£å¥—è£… + ä¼‘é—²å¤§è¡£",
                types: { top: 'hoodie', outer: 'coat', bottom: 'pants' },
                colors: { top: ['#d4c4b7', '#f5f5dc'], bottom: ['#d4c4b7', '#f5f5dc'], outer: ['#d4c4b7', '#a8a29e'] }
            }
        };

        const EMOJI_LIST = [
            'ğŸ‘•', 'ğŸ‘š', 'ğŸ½', 'ğŸ‘”', 'ğŸ§¥', 'ğŸ§¶', 'ğŸ‘—', 'ğŸ‘˜', 'ğŸ¥»', 'ğŸ‘™', 'ğŸ©²', 'ğŸ©³',
            'ğŸ‘–', 'ğŸ§£', 'ğŸ§¤', 'ğŸ§¢', 'ğŸ©', 'ğŸ‘¢', 'ğŸ‘Ÿ', 'ğŸ˜·', 'ğŸ”¥', 'â„ï¸', 'â˜€ï¸', 'â˜ï¸'
        ];

        // 3. App é€»è¾‘ (åŸ app.js)
        // ------- å…¨å±€ UI æ§åˆ¶å‡½æ•° -------
        function forceCloseIntro() {
            const overlay = document.getElementById('introOverlay');
            if (overlay) {
                overlay.style.opacity = '0';
                overlay.style.pointerEvents = 'none';
                setTimeout(() => {
                    overlay.style.display = 'none';
                    overlay.classList.add('hidden');
                }, 500);
            }
        }
        
        function toggleCitySearch(show) {
            const modal = document.getElementById('citySearchModal');
            if (!modal) return;
            if (show) {
                modal.classList.remove('hidden');
                const inp = document.getElementById('citySearchInput');
                if (inp) inp.focus();
                if (window.initBrowseView) window.initBrowseView();
            } else {
                modal.classList.add('hidden');
            }
        }
        
        function toggleSettings(show) {
            const modal = document.getElementById('settingsModal');
            if (modal) modal.classList[show ? 'remove' : 'add']('hidden');
        }
        
        function toggleCustomModal(show, type) {
            const modal = document.getElementById('customModal');
            if (!modal) return;
            modal.classList[show ? 'remove' : 'add']('hidden');
            if (show && window.setupCustomModal) window.setupCustomModal(type);
        }
        
        function hideContextMenu() {
            const menu = document.getElementById('contextMenu');
            if (menu) menu.style.display = 'none';
        }
        
        // 5 ç§’ä¿é™©
        setTimeout(forceCloseIntro, 5000);
        
        // ------- æ•°æ®ä¸çŠ¶æ€ -------
        let clothingDB = { tops: [], bottoms: [] };
        let selectedItems = [];
        let isCelsius = true;
        let userBaseTarget = 26;
        let userOffset = 0;
        let lastWeatherData = null;
        let currentTopColor = '#e5e7eb';
        let currentBottomColor = '#374151';
        let currentOuterColor = '#9ca3af'; 
        
        let currentRatio = '5/5';
        let currentItemTypes = { top: 'tshirt', bottom: 'pants', outer: 'coat' };
        
        let ctxTarget = null;
        
        // ------- åˆå§‹åŒ– -------
        document.addEventListener('DOMContentLoaded', () => {
            try {
                loadClothingDB();
                bindEvents();
                
                initColorPage(); 
                initStyleSelector();
                updatePreview();
                
                renderBtns();
                updateCalculator();
                initLocation();

                setInterval(() => {
                    const n = new Date();
                    const clock = document.getElementById('digitalClock');
                    const dateLabel = document.getElementById('greetingDate');
                    const title = document.getElementById('greetingTitle');
                    if (!clock || !dateLabel || !title) return;
                    clock.textContent = `${String(n.getHours()).padStart(2, '0')}:${String(n.getMinutes()).padStart(2, '0')}`;
                    const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
                    dateLabel.textContent = `${n.getMonth() + 1}æœˆ${n.getDate()}æ—¥ ${days[n.getDay()]}`;
                    const h = n.getHours();
                    title.textContent = h < 11 ? 'æ—©ä¸Šå¥½' : h < 13 ? 'ä¸­åˆå¥½' : h < 18 ? 'ä¸‹åˆå¥½' : 'æ™šä¸Šå¥½';
                }, 1000);
            } catch (e) { 
                console.error("Critical Init Error:", e); 
                forceCloseIntro();
            }
        });
        
        // ------- æ ¸å¿ƒå‡½æ•° -------
        function loadClothingDB() {
            try {
                const saved = localStorage.getItem('clothingDB_v3'); 
                if (saved) { 
                    clothingDB = JSON.parse(saved); 
                    if(!clothingDB.tops || !Array.isArray(clothingDB.tops)) throw new Error("Invalid Data");
                } else { 
                    clothingDB = JSON.parse(JSON.stringify(DEFAULT_CLOTHING)); 
                    saveDB();
                }
            } catch(e) {
                console.warn("Local data corrupted, resetting.");
                clothingDB = JSON.parse(JSON.stringify(DEFAULT_CLOTHING)); 
                saveDB();
            }
        }

        function saveDB() { localStorage.setItem('clothingDB_v3', JSON.stringify(clothingDB)); renderBtns(); }
        function resetClothingDB() { localStorage.removeItem('clothingDB_v3'); loadClothingDB(); renderBtns(); toggleSettings(false); }
        function toDisplayTemp(c) { return isCelsius ? c : c * 1.8 + 32; }
        function toDisplayDelta(c) { return isCelsius ? c : c * 1.8; }
        function toBaseDelta(val) { return isCelsius ? val : val / 1.8; }
        function formatNum(n) { return isCelsius ? Math.round(n) : n.toFixed(1); }
        
        async function initLocation() {
            try {
                const res = await fetch('https://ipwho.is/?lang=zh-CN');
                const d = await res.json();
                if (d.success) window.appFetchWeather(d.latitude, d.longitude, d.city); else throw new Error();
            } catch (e) {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(p => window.appFetchWeather(p.coords.latitude, p.coords.longitude, null), () => forceCloseIntro());
                } else { forceCloseIntro(); }
            }
        }
        
        window.appFetchWeather = async function (lat, lon, name) {
            try {
                const city = name || 'æœ¬åœ°';
                const elLoc = document.getElementById('locationName');
                if(elLoc) elLoc.textContent = city;
                const elBadge = document.getElementById('locationBadge');
                if(elBadge) elBadge.classList.remove('hidden');
                
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,wind_speed_10m,cloud_cover,weathercode,is_day&wind_speed_unit=ms&timezone=auto`;
                const res = await fetch(url); const data = await res.json();
                if (data.current) {
                    lastWeatherData = data.current;
                    updateWeatherDisplay();
                    document.querySelectorAll('.modifier-btn').forEach(b => b.classList.remove('active'));
                    const wind = data.current.wind_speed_10m ?? data.current.windspeed_10m ?? 0;
                    const modWind = document.getElementById('modWind');
                    const modHumid = document.getElementById('modHumid');
                    const modSun = document.getElementById('modSun');

                    if (modWind && wind > 4) modWind.classList.add('active');
                    if (modHumid && ((data.current.temperature_2m < 20 && data.current.relative_humidity_2m > 75) || data.current.weathercode >= 51)) modHumid.classList.add('active');
                    if (modSun && data.current.weathercode <= 1 && data.current.is_day === 1) modSun.classList.add('active');
                    updateCalculator();
                    forceCloseIntro();
                }
            } catch (e) { forceCloseIntro(); }
        };
        
        function updateWeatherDisplay() {
            if (!lastWeatherData) return;
            const cur = lastWeatherData;
            const amb = document.getElementById('ambientTemp');
            if(amb) amb.value = formatNum(toDisplayTemp(cur.temperature_2m));
            
            const liveData = document.getElementById('liveWeatherData');
            if(liveData) liveData.classList.remove('hidden');
            
            const elHumid = document.getElementById('liveHumidity');
            if(elHumid) elHumid.textContent = cur.relative_humidity_2m;
            
            const elWind = document.getElementById('liveWind');
            if(elWind) elWind.textContent = cur.wind_speed_10m ?? cur.windspeed_10m ?? 0;
            
            const elApp = document.getElementById('liveApparent');
            if(elApp) elApp.textContent = formatNum(toDisplayTemp(cur.apparent_temperature ?? cur.temperature_2m));
        }
        
        function renderBtns() {
            const render = (type, container) => {
                if (!container) return;
                container.innerHTML = '';
                if(!clothingDB[type]) return;
                
                clothingDB[type].forEach((item, idx) => {
                    const btn = document.createElement('button');
                    const uid = `${type}-${idx}-${item.name}`;
                    const isSel = selectedItems.some(i => i._uid === uid);
                    let ex = '';
                    if (type === 'bottoms') {
                        const cls = item.layer === 'inner' ? 'layer-inner' : 'layer-outer';
                        const txt = item.layer === 'inner' ? 'å†…' : 'å¤–';
                        ex = `<span class="layer-tag ${cls}">${txt}</span>`;
                    }
                    btn.className = 'clothing-btn w-full text-left px-2 py-2 rounded-lg border border-gray-200 bg-white text-gray-700 flex flex-col items-center justify-center gap-1 ' + (isSel ? 'selected' : '');
                    btn.oncontextmenu = e => window.showContextMenu(e, type, idx);
                    btn.onclick = () => {
                        const exIdx = selectedItems.findIndex(i => i._uid === uid);
                        if (exIdx > -1) { selectedItems.splice(exIdx, 1); btn.classList.remove('selected'); } 
                        else {
                            if (type === 'bottoms') {
                                const conf = selectedItems.findIndex(i => i.type === 'bottoms' && i.layer === item.layer);
                                if (conf > -1) selectedItems.splice(conf, 1);
                            }
                            selectedItems.push({ ...item, _uid: uid, type });
                        }
                        renderBtns(); updateCalculator();
                    };
                    btn.innerHTML = `<span class="text-lg">${item.icon}</span><span class="text-center text-[10px] w-full whitespace-normal h-6 flex items-center justify-center">${item.name}</span><span class="font-bold text-amber-600 bg-amber-50 px-1 rounded text-[9px]">${formatNum(toDisplayDelta(item.temp))}Â°</span>` + ex;
                    container.appendChild(btn);
                });
            };
            render('tops', document.getElementById('topsContainer'));
            render('bottoms', document.getElementById('bottomsContainer'));
        }
        
        window.updateCalculator = function () {
            const ambInput = document.getElementById('ambientTemp'); if (!ambInput) return;
            const inputVal = parseFloat(ambInput.value);
            const safeInput = isNaN(inputVal) ? 20 : inputVal;
            
            const rawBase = isCelsius ? safeInput : (safeInput - 32) / 1.8;
            let modSum = 0;
            document.querySelectorAll('.modifier-btn.active').forEach(b => { modSum += parseFloat(b.dataset.val); });
            
            const eff = rawBase + modSum;
            const target = userBaseTarget + userOffset;
            const elTarget = document.getElementById('targetDisplay');
            if(elTarget) elTarget.textContent = `${target}Â°`;
            
            const total = selectedItems.reduce((s, i) => s + i.temp, 0);
            const need = target - eff - total;
            
            const elNeed = document.getElementById('neededTemp');
            if(elNeed) elNeed.textContent = formatNum(toDisplayDelta(need));
            
            const elCurr = document.getElementById('currentTemp');
            if(elCurr) elCurr.textContent = formatNum(toDisplayDelta(total));
            
            const elReal = document.getElementById('realFeelDisplay');
            if(elReal) elReal.innerHTML = `${formatNum(toDisplayTemp(eff))}<span class="text-[10px]">${isCelsius ? 'Â°C' : 'Â°F'}</span>` + (modSum !== 0 ? ` (ä¿®${modSum > 0 ? '+' : ''}${formatNum(toDisplayDelta(modSum))}Â°)` : '');
            
            const meterMarker = document.getElementById('meterMarker');
            if (meterMarker) { const p = Math.max(5, Math.min(95, 50 + (eff + total - target) * 5)); meterMarker.style.left = `${p}%`; }
            const ft = document.getElementById('feelingText');
            if (ft) { if (need > 1) ft.innerHTML = '<span class="text-blue-400">ğŸ¥¶ å†·</span>'; else if (need < -1) ft.innerHTML = '<span class="text-red-400">ğŸ¥µ çƒ­</span>'; else ft.innerHTML = '<span class="text-green-500">âœ¨ é€‚</span>'; }
        };
        
        // ------- äº‹ä»¶ç»‘å®š -------
        function bindEvents() {
            const btnC = document.getElementById('btnCelsius');
            const btnF = document.getElementById('btnFahrenheit');
            if (btnC) btnC.onclick = () => { if (!isCelsius) { isCelsius = true; updateUI(); } };
            if (btnF) btnF.onclick = () => { if (isCelsius) { isCelsius = false; updateUI(); } };
            const btnLoc = document.getElementById('locateBtn');
            if (btnLoc) btnLoc.onclick = () => initLocation();
            const btnReset = document.getElementById('resetButton');
            if (btnReset) btnReset.onclick = () => { selectedItems = []; renderBtns(); updateCalculator(); };
            
            const ambTemp = document.getElementById('ambientTemp');
            if (ambTemp) ambTemp.oninput = updateCalculator;
            
            const targetInp = document.getElementById('targetTempInput');
            if (targetInp) targetInp.onchange = e => { userBaseTarget = parseFloat(e.target.value) || 26; updateCalculator(); };
            
            document.querySelectorAll('.modifier-btn').forEach(b => { b.onclick = () => { b.classList.toggle('active'); updateCalculator(); }; });
            
            const searchInput = document.getElementById('citySearchInput');
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', e => {
                    const q = e.target.value.trim();
                    const resDiv = document.getElementById('searchResultsView');
                    const browse = document.getElementById('browseView');
                    const az = document.getElementById('azSidebar');
                    const loading = document.getElementById('searchLoading');
                    if (!resDiv || !browse || !az || !loading) return;
                    if (!q) { browse.classList.remove('hidden'); az.style.display = 'flex'; resDiv.classList.add('hidden'); return; }
                    browse.classList.add('hidden'); az.style.display = 'none'; resDiv.classList.remove('hidden'); loading.classList.remove('hidden');
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(async () => {
                        try {
                            const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=5&language=zh&format=json`);
                            const data = await res.json();
                            loading.classList.add('hidden');
                            if (!data.results) { resDiv.innerHTML = '<div class="text-center text-gray-400 py-4">æ— ç»“æœ</div>'; return; }
                            resDiv.innerHTML = '';
                            data.results.forEach(top => {
                                const d = document.createElement('div');
                                const region = [top.admin1, top.country].filter(Boolean).join(', ');
                                d.className = 'bg-white border border-amber-100 rounded-lg p-3 flex justify-between items-center cursor-pointer hover:bg-amber-50 mb-2';
                                d.innerHTML = `<div class="flex items-center gap-3"><div class="text-xl">ğŸŒ</div><div><div class="font-bold text-gray-800 text-sm">${top.name}</div><div class="text-xs text-gray-400">${region}</div></div></div>`;
                                d.onclick = () => { toggleCitySearch(false); window.appFetchWeather(top.latitude, top.longitude, top.name); };
                                resDiv.appendChild(d);
                            });
                        } catch (err) { loading.classList.add('hidden'); }
                    }, 300);
                });
                searchInput.onclick = e => e.stopPropagation();
            }
        }
        
        function updateUI() {
            const btnC = document.getElementById('btnCelsius'); const btnF = document.getElementById('btnFahrenheit');
            if (btnC) btnC.className = isCelsius ? 'px-3 py-1 rounded-md font-bold text-xs transition-all bg-amber-500 text-white' : 'px-3 py-1 rounded-md font-bold text-xs transition-all text-amber-800';
            if (btnF) btnF.className = !isCelsius ? 'px-3 py-1 rounded-md font-bold text-xs transition-all bg-amber-500 text-white' : 'px-3 py-1 rounded-md font-bold text-xs transition-all text-amber-800';
            document.querySelectorAll('.unit-label').forEach(e => { e.textContent = isCelsius ? 'Â°C' : 'Â°F'; });
            const ambient = document.getElementById('ambientTemp');
            if (ambient) { const amb = parseFloat(ambient.value); if (!isNaN(amb)) { ambient.value = formatNum(isCelsius ? (amb - 32) / 1.8 : amb * 1.8 + 32); } }
            if (lastWeatherData) { const app = lastWeatherData.apparent_temperature ?? lastWeatherData.temperature_2m; const appElem = document.getElementById('liveApparent'); if (appElem) appElem.textContent = formatNum(toDisplayTemp(app)); }
            document.querySelectorAll('.modifier-btn').forEach(btn => {
                const b = parseFloat(btn.dataset.val); const s = b > 0 ? '+' : '';
                const label = btn.querySelector('.mod-val'); if (label) label.textContent = `${s}${formatNum(toDisplayDelta(b))}${isCelsius ? 'Â°' : 'Â°F'}`;
            });
            renderBtns(); updateCalculator();
        }
        
        // ------- è¾…åŠ©å‡½æ•° -------
        window.showContextMenu = function (e, type, idx) { e.preventDefault(); ctxTarget = { type, idx }; const m = document.getElementById('contextMenu'); if (!m) return; m.style.left = `${e.clientX}px`; m.style.top = `${e.clientY}px`; m.style.display = 'block'; };
        window.handleDeleteCustom = function () { if (!ctxTarget) return; clothingDB[ctxTarget.type].splice(ctxTarget.idx, 1); selectedItems = []; saveDB(); updateCalculator(); }; 
        window.handleEditCustom = function () { if (ctxTarget) openEditModal(ctxTarget.type, ctxTarget.idx); };
        window.setupCustomModal = function (type) { 
            const modalTitle = document.getElementById('modalTitle'); const typeInput = document.getElementById('customType'); const editIndex = document.getElementById('editIndex'); const layerSelector = document.getElementById('layerSelector'); const nameInput = document.getElementById('customName'); const tempInput = document.getElementById('customTemp'); const tempLabel = document.getElementById('tempInputLabel');
            if (!modalTitle) return;
            modalTitle.textContent = 'ğŸ¨ æ·»åŠ è¡£ç‰©'; typeInput.value = type; editIndex.value = -1; layerSelector.classList[type === 'bottoms' ? 'remove' : 'add']('hidden'); nameInput.value = ''; tempInput.value = ''; tempLabel.textContent = `å‡æ¸©å€¼ (${isCelsius ? 'Â°C' : 'Â°F'})`; document.getElementById('selectedEmoji').value = 'ğŸ‘•'; renderEmojiPicker();
        };
        function openEditModal(type, idx) {
            toggleCustomModal(true, null); const modalTitle = document.getElementById('modalTitle'); const typeInput = document.getElementById('customType'); const editIndex = document.getElementById('editIndex'); const layerSelector = document.getElementById('layerSelector'); const tempLabel = document.getElementById('tempInputLabel'); const nameInput = document.getElementById('customName'); const tempInput = document.getElementById('customTemp');
            modalTitle.textContent = 'âœï¸ ç¼–è¾‘è¡£ç‰©'; typeInput.value = type; editIndex.value = idx; layerSelector.classList[type === 'bottoms' ? 'remove' : 'add']('hidden'); tempLabel.textContent = `å‡æ¸©å€¼ (${isCelsius ? 'Â°C' : 'Â°F'})`; const item = clothingDB[type][idx]; nameInput.value = item.name; tempInput.value = formatNum(toDisplayDelta(item.temp)); document.getElementById('selectedEmoji').value = item.icon;
            if (type === 'bottoms' && item.layer) { const radio = document.getElementById(item.layer === 'inner' ? 'layerInner' : 'layerOuter'); if (radio) radio.checked = true; } renderEmojiPicker();
        }
        window.saveCustomItem = function () {
            const typeInput = document.getElementById('customType'); const editIndex = document.getElementById('editIndex'); const tempInput = document.getElementById('customTemp'); const nameInput = document.getElementById('customName'); const emojiInput = document.getElementById('selectedEmoji');
            if (!typeInput) return;
            const tKey = typeInput.value === 'tops' ? 'tops' : 'bottoms'; const idx = parseInt(editIndex.value, 10); const val = parseFloat(tempInput.value); if (isNaN(val)) return;
            const item = { name: nameInput.value, temp: toBaseDelta(val), icon: emojiInput.value, layer: tKey === 'bottoms' ? (document.querySelector('input[name="customLayer"]:checked') || {}).value || 'outer' : undefined };
            if (idx >= 0) clothingDB[tKey][idx] = item; else clothingDB[tKey].push(item); saveDB(); toggleCustomModal(false); updateCalculator();
        }
        function renderEmojiPicker() {
            const g = document.getElementById('emojiGrid'); const curInput = document.getElementById('selectedEmoji'); if (!g || !curInput) return; const cur = curInput.value; g.innerHTML = '';
            if(typeof EMOJI_LIST === 'undefined') return;
            EMOJI_LIST.forEach(e => { const d = document.createElement('div'); d.className = `emoji-option ${e === cur ? 'selected' : ''}`; d.textContent = e; d.onclick = () => { curInput.value = e; document.querySelectorAll('.emoji-option').forEach(x => x.classList.remove('selected')); d.classList.add('selected'); }; g.appendChild(d); });
        }
        window.setPreference = function (t) {
            document.querySelectorAll('.pref-option').forEach(e => e.classList.remove('active')); const target = document.querySelector(`.pref-option[data-type="${t}"]`); if (target) target.classList.add('active');
            if (t === 'hot') userOffset = -2; else if (t === 'cold') userOffset = 2; else userOffset = 0; updateCalculator();
        };
        window.switchTab = function (t) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active')); document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            const view = document.getElementById(t === 'calc' ? 'viewCalc' : 'viewColor'); const tab = document.getElementById(t === 'calc' ? 'tabCalc' : 'tabColor'); if (view) view.classList.add('active'); if (tab) tab.classList.add('active');
        };
        
        function initStyleSelector() {
            const sel = document.getElementById('styleSelector');
            if (!sel) return;
            sel.innerHTML = '<option value="random">ğŸ² éšæœºå…¨é£æ ¼ (Random)</option>';
            for(const [key, val] of Object.entries(STYLES)) {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = val.name;
                sel.appendChild(opt);
            }
        }

        function initColorPage() {
            const rp = (id, type) => { 
                const c = document.getElementById(id);
                if (!c) return;
                c.innerHTML = '';
                PALETTE.forEach(col => {
                    const d = document.createElement('div');
                    d.className = 'color-swatch';
                    d.style.backgroundColor = col.c;
                    if (col.c.toLowerCase() === '#ffffff') d.style.border = '1px solid #e5e7eb';
                    
                    const cur = type === 'top' ? currentTopColor : (type === 'bottom' ? currentBottomColor : currentOuterColor);
                    if(col.c.toLowerCase() === cur.toLowerCase()) d.classList.add('active');

                    d.onclick = () => {
                        setColor(type, col.c);
                    };
                    c.appendChild(d);
                });
            };
            rp('topPalette', 'top');
            rp('bottomPalette', 'bottom');
            rp('outerPalette', 'outer');
            updateColorName('top', currentTopColor);
            updateColorName('bottom', currentBottomColor);
            updateColorName('outer', currentOuterColor);
            document.getElementById('topTypeSel').value = currentItemTypes.top;
            document.getElementById('bottomTypeSel').value = currentItemTypes.bottom;
            document.getElementById('outerTypeSel').value = currentItemTypes.outer;
        }

        function setColor(type, color) {
            if (type === 'top') currentTopColor = color;
            else if (type === 'bottom') currentBottomColor = color;
            else if (type === 'outer') currentOuterColor = color;
            updatePreview(); 
            initColorPage(); 
            updateColorName(type, color);
            analyzeColor();
        }
        
        window.setClothingType = function(layer, type) {
            currentItemTypes[layer] = type;
            updatePreview();
        }
        
        window.setProportion = function(ratio) {
            currentRatio = ratio;
            document.querySelectorAll('.ratio-btn').forEach(b => b.classList.remove('active'));
            if(ratio === '5/5') document.getElementById('ratio55').classList.add('active');
            else document.getElementById('ratio37').classList.add('active');
            updatePreview();
        }
        
        window.updateCustomColor = function(type, color) {
            setColor(type, color);
        }

        function getColorName(colorHex) {
            const match = PALETTE.find(p => p.c.toLowerCase() === colorHex.toLowerCase());
            return match ? match.n : colorHex;
        }
        
        function buildCurrentItemsText() {
            const outerText  = `${getColorName(currentOuterColor)}${TYPE_LABELS.outer[currentItemTypes.outer] || ''}`;
            const topText    = `${getColorName(currentTopColor)}${TYPE_LABELS.top[currentItemTypes.top] || ''}`;
            const bottomText = `${getColorName(currentBottomColor)}${TYPE_LABELS.bottom[currentItemTypes.bottom] || ''}`;
            return `${outerText} + ${topText} + ${bottomText}`;
        }

        function updateColorName(type, colorHex) {
            const label = document.getElementById(type === 'top' ? 'colorNameTop' : (type === 'bottom' ? 'colorNameBottom' : 'colorNameOuter'));
            if(!label) return;
            const match = PALETTE.find(p => p.c.toLowerCase() === colorHex.toLowerCase());
            label.textContent = match ? `${match.n} (${match.c})` : `è‡ªå®šä¹‰ (${colorHex})`;
        }

        function updatePreview() {
            const topAsset = CLOTHING_ASSETS.top[currentItemTypes.top] || CLOTHING_ASSETS.top.tshirt;
            const bottomAsset = CLOTHING_ASSETS.bottom[currentItemTypes.bottom] || CLOTHING_ASSETS.bottom.pants;
            const outerAsset = CLOTHING_ASSETS.outer[currentItemTypes.outer] || CLOTHING_ASSETS.outer.coat;
            
            const elPathTop = document.getElementById('pathTop');
            if(elPathTop) {
                elPathTop.setAttribute('d', topAsset.path);
                document.getElementById('detailTop').setAttribute('d', topAsset.detail);
                elPathTop.setAttribute('fill', currentTopColor);
            }
            
            const elPathBottom = document.getElementById('pathBottom');
            if(elPathBottom) {
                elPathBottom.setAttribute('d', bottomAsset.path);
                document.getElementById('detailBottom').setAttribute('d', bottomAsset.detail);
                elPathBottom.setAttribute('fill', currentBottomColor);
            }

            const elPathOuter = document.getElementById('pathOuter');
            if(elPathOuter) {
                 elPathOuter.setAttribute('d', outerAsset.path);
                 document.getElementById('detailOuter').setAttribute('d', outerAsset.detail);
                 elPathOuter.setAttribute('fill', currentOuterColor);
            }
            
            const svgTop = document.getElementById('svgTop');
            const svgBottom = document.getElementById('svgBottom');
            const svgOuter = document.getElementById('svgOuter');
            
            if(svgTop && svgBottom && svgOuter) {
                    if (currentRatio === '3/7') {
                        svgBottom.style.zIndex = '15';
                        svgTop.style.zIndex = '10';
                        svgTop.style.transform = 'translateY(-30px)';
                        svgBottom.style.transform = 'translateY(0px)';
                        svgOuter.style.transform = 'translateY(-15px)';
                    } else {
                        svgTop.style.zIndex = '15';
                        svgBottom.style.zIndex = '10';
                        svgTop.style.transform = 'translateY(0px)';
                        svgBottom.style.transform = 'translateY(20px)';
                        svgOuter.style.transform = 'translateY(0px)';
                    }
            }
        }

        function analyzeColor() {
            const currentAdvice = document.getElementById('colorAdvice').textContent;
            if(currentAdvice.includes("æ¨èå•å“")) return;

            const hexToRgb = h => { let r=0,g=0,b=0; if(h.length==4){r=parseInt(h[1]+h[1],16);g=parseInt(h[2]+h[2],16);b=parseInt(h[3]+h[3],16);} else if(h.length==7){r=parseInt(h[1]+h[2],16);g=parseInt(h[3]+h[4],16);b=parseInt(h[5]+h[6],16);} return {r,g,b}; };
            const getLum = (hex) => { const c=hexToRgb(hex); return (0.299*c.r + 0.587*c.g + 0.114*c.b); };
            const tLum = getLum(currentTopColor);
            
            let advice = "âœ¨ è‡ªå®šä¹‰æ­é…ï¼š";
            if (tLum > 200) advice += "æ•´ä½“è‰²è°ƒè½»ç›ˆï¼Œè§†è§‰æ¸…çˆ½ã€‚";
            else advice += "æ•´ä½“è‰²è°ƒæ²‰ç¨³ï¼Œçªå‡ºè´¨æ„Ÿã€‚";
            document.getElementById('colorAdvice').textContent = advice;
        }

        window.generateOutfit = function() {
            const selector = document.getElementById('styleSelector');
            const selectedKey = selector ? selector.value : 'random';
            let targetStyle;
            
            if (selectedKey === 'random') {
                const keys = Object.keys(STYLES);
                const randomKey = keys[Math.floor(Math.random() * keys.length)];
                targetStyle = STYLES[randomKey];
            } else {
                targetStyle = STYLES[selectedKey];
            }
            
            if (!targetStyle) return;

            const pick = arr => arr[Math.floor(Math.random() * arr.length)];
            
            setColor('top', pick(targetStyle.colors.top));
            setColor('bottom', pick(targetStyle.colors.bottom));
            setColor('outer', pick(targetStyle.colors.outer));
            
            if (targetStyle.types) {
                setClothingType('top', targetStyle.types.top);
                setClothingType('bottom', targetStyle.types.bottom);
                setClothingType('outer', targetStyle.types.outer);
                
                document.getElementById('topTypeSel').value = targetStyle.types.top;
                document.getElementById('bottomTypeSel').value = targetStyle.types.bottom;
                document.getElementById('outerTypeSel').value = targetStyle.types.outer;
            }

            const adviceBox = document.getElementById('colorAdvice');
            const currentItems = buildCurrentItemsText();

            adviceBox.innerHTML = `
                <span class="font-bold text-amber-600">âœ¨ ${targetStyle.name}</span><br>
                <span class="text-xs text-gray-500">${targetStyle.desc}</span><br>
                <div class="mt-2 p-2 bg-white rounded border border-amber-100 text-xs">
                    <strong>ğŸ’¡ æ¨èå•å“ï¼š</strong>${currentItems}
                    ${targetStyle.items ? `<div class="mt-1 text-[10px] text-gray-400">é£æ ¼å‚è€ƒï¼š${targetStyle.items}</div>` : ''}
                </div>
            `;
        }
    </script>
</body>
</html>
